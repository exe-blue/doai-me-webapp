<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <title>DoAi Desktop Agent</title>
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #1f2937;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --accent: #3b82f6;
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --border: #334155;
      --sidebar-width: 200px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      -webkit-app-region: drag;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }

    .title {
      font-size: 16px;
      font-weight: 600;
    }

    .node-id {
      font-size: 12px;
      color: var(--text-secondary);
      background: var(--bg-card);
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    /* Status Badge */
    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.connected {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .status-badge.disconnected {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    .status-badge.connecting {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-dot.pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Header Action Buttons */
    .header-action-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }
    .header-action-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--text-secondary);
    }
    .header-action-btn.btn-restart:hover {
      border-color: var(--warning);
      color: var(--warning);
    }

    /* Node Status Banner */
    .node-status-banner {
      padding: 4px 16px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .node-status-banner .ns-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .node-status-banner .ns-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .node-status-banner .ns-dot.ok { background: var(--success); }
    .node-status-banner .ns-dot.off { background: var(--text-secondary); opacity: 0.4; }

    /* Main Layout */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .nav-group {
      margin-bottom: 16px;
    }

    .nav-group-title {
      padding: 12px 16px 8px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.15s;
      border-left: 3px solid transparent;
      font-size: 13px;
      -webkit-app-region: no-drag;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-item.active {
      background: rgba(59, 130, 246, 0.15);
      border-left-color: var(--accent);
      color: var(--accent);
    }

    .nav-item-icon {
      font-size: 16px;
    }

    /* Content Area */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Section Headers */
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-subtitle {
      font-size: 14px;
      font-weight: 600;
      margin: 24px 0 12px;
      color: var(--text-secondary);
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 16px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-content {
      font-size: 13px;
      line-height: 1.5;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid var(--border);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }

    .stat-value.success { color: var(--success); }
    .stat-value.warning { color: var(--warning); }
    .stat-value.error { color: var(--error); }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
      -webkit-app-region: no-drag;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
    }

    .btn-group {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    /* Filter Buttons */
    .filter-btn {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
      -webkit-app-region: no-drag;
    }

    .filter-btn:hover {
      background: var(--bg-secondary);
    }

    .filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Log Container */
    .log-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      max-height: calc(100vh - 300px);
      overflow-y: auto;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      line-height: 1.6;
    }

    .log-entry {
      padding: 4px 8px;
      border-radius: 4px;
      margin-bottom: 2px;
      display: flex;
      gap: 8px;
    }

    .log-entry:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .log-time {
      color: var(--text-secondary);
      flex-shrink: 0;
      min-width: 80px;
    }

    .log-level-badge {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      flex-shrink: 0;
      min-width: 50px;
      text-align: center;
    }

    .log-level-badge.INFO {
      background: rgba(59, 130, 246, 0.2);
      color: var(--accent);
    }

    .log-level-badge.WARN {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .log-level-badge.ERROR {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    .log-category {
      color: var(--text-secondary);
      flex-shrink: 0;
      min-width: 80px;
      font-size: 10px;
    }

    .log-message {
      flex: 1;
      word-break: break-word;
    }

    /* Table */
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .table thead {
      background: var(--bg-secondary);
    }

    .table th {
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
    }

    .table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }

    .table tbody tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    /* Status Badges in Table */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge.online {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .badge.busy {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .badge.error {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    .badge.offline {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-secondary);
    }

    .badge.running {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .badge.idle {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-secondary);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Health Check Cards */
    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
    }

    .health-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .health-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .health-card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .health-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .health-status.ok {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .health-status.error {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    .health-status.missing {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-secondary);
    }

    .health-card-body {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .health-card-body div {
      margin-bottom: 4px;
    }

    /* Pipeline Stepper */
    .pipeline-stepper {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .pipeline-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 100px;
    }

    .pipeline-step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .pipeline-step.active .pipeline-step-icon {
      background: var(--accent);
      border-color: var(--accent);
      animation: pulse 2s infinite;
    }

    .pipeline-step-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
    }

    .pipeline-arrow {
      font-size: 20px;
      color: var(--text-secondary);
      margin: 0 -8px;
    }

    /* Bot Catalog */
    .bot-catalog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }

    .bot-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .bot-card-header {
      display: flex;
      align-items: start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .bot-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .bot-info {
      flex: 1;
    }

    .bot-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .bot-category {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .bot-description {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .bot-capabilities {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }

    .bot-tag {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      color: var(--text-secondary);
      text-align: center;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 14px;
      margin-bottom: 4px;
    }

    .empty-state-subtext {
      font-size: 12px;
      opacity: 0.7;
    }

    /* Device Detail Panel */
    .device-panel-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 99;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .device-panel-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .device-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 360px;
      height: 100vh;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
      display: flex;
      flex-direction: column;
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
    }

    .device-panel.open {
      transform: translateX(0);
    }

    .device-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .device-panel-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .device-panel-serial {
      font-size: 12px;
      color: var(--text-secondary);
      font-family: 'SF Mono', Monaco, monospace;
    }

    .device-panel-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-card);
      color: var(--text-secondary);
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      -webkit-app-region: no-drag;
    }

    .device-panel-close:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    .device-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .device-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }

    .device-info-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 12px;
      border: 1px solid var(--border);
    }

    .device-info-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .device-info-value {
      font-size: 14px;
      font-weight: 600;
    }

    .btn-scrcpy {
      width: 100%;
      padding: 14px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s;
      margin-bottom: 16px;
      font-family: inherit;
      -webkit-app-region: no-drag;
    }

    .btn-scrcpy:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-scrcpy.active {
      background: var(--success);
    }

    .btn-scrcpy.active:hover {
      background: #16a34a;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .btn-scrcpy:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .device-action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .device-action-grid .btn {
      justify-content: center;
      font-size: 12px;
      padding: 10px;
    }

    .table tbody tr.clickable {
      cursor: pointer;
      transition: background 0.15s;
    }

    .table tbody tr.clickable:hover {
      background: rgba(59, 130, 246, 0.08);
    }

    .table tbody tr.clickable.scrcpy-active {
      border-left: 3px solid var(--success);
    }

    .scrcpy-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
      margin-right: 6px;
    }

    /* APK Install Cards */
    .apk-section {
      margin-top: 8px;
    }

    .apk-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .apk-card {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }

    .apk-icon {
      width: 36px;
      height: 36px;
      background: var(--bg-secondary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .apk-info {
      flex: 1;
      min-width: 0;
    }

    .apk-name {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .apk-size {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .btn-apk-install {
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: var(--accent);
      color: white;
      white-space: nowrap;
      transition: all 0.15s;
      font-family: inherit;
      -webkit-app-region: no-drag;
    }

    .btn-apk-install:hover {
      background: #2563eb;
    }

    .btn-apk-install:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-apk-install.success {
      background: var(--success);
    }

    .btn-apk-install.error {
      background: var(--error);
    }

    .apk-empty {
      text-align: center;
      color: var(--text-secondary);
      font-size: 12px;
      padding: 16px;
    }

    /* Footer */
    .footer {
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="logo">D</div>
        <span class="title">DoAi Desktop Agent</span>
        <span class="node-id" id="nodeId">NODE-1</span>
      </div>
      <div class="header-right">
        <button class="header-action-btn" onclick="handleRefresh()" title="ì„œë²„ ì¬ì—°ê²°">&#x21bb; ìƒˆë¡œê³ ì¹¨</button>
        <button class="header-action-btn btn-restart" onclick="handleRestart()" title="ì•± ì¬ì‹œì‘">&#x23fb; ì¬ì‹œì‘</button>
        <div class="status-badge connecting" id="serverStatus">
          <span class="status-dot pulse"></span>
          <span id="serverStatusText">ì—°ê²° ì¤‘...</span>
        </div>
      </div>
    </header>

    <!-- Node Status Banner (v1.2.0) -->
    <div class="node-status-banner" id="nodeStatusBanner">
      <span class="ns-item"><span class="ns-dot off" id="nsBannerServer"></span> ì„œë²„</span>
      <span class="ns-item"><span class="ns-dot off" id="nsBannerWorker"></span> Worker ì„œë²„</span>
      <span class="ns-item" id="nsBannerDevices">ê¸°ê¸° 0ëŒ€</span>
    </div>

    <!-- Main Container -->
    <div class="main-container">
      <!-- Sidebar Navigation -->
      <nav class="sidebar">
        <div class="nav-group">
          <div class="nav-group-title">ìš´ì˜</div>
          <div class="nav-item active" data-tab="logging" onclick="switchTab('logging')">
            <span class="nav-item-icon">ğŸ“‹</span>
            <span>ì‹¤ì‹œê°„ ë¡œê¹…</span>
          </div>
          <div class="nav-item" data-tab="heatmap" onclick="switchTab('heatmap')">
            <span class="nav-item-icon">ğŸ“Š</span>
            <span>íˆíŠ¸ë§µ</span>
          </div>
          <div class="nav-item" data-tab="devices" onclick="switchTab('devices')">
            <span class="nav-item-icon">ğŸ“±</span>
            <span>ê¸°ê¸°ê´€ë¦¬</span>
          </div>
        </div>

        <div class="nav-group">
          <div class="nav-group-title">ì¸í”„ë¼</div>
          <div class="nav-item" data-tab="clients" onclick="switchTab('clients')">
            <span class="nav-item-icon">ğŸ¤–</span>
            <span>í´ë¼ì´ì–¸íŠ¸</span>
          </div>
          <div class="nav-item" data-tab="infra" onclick="switchTab('infra')">
            <span class="nav-item-icon">ğŸ”§</span>
            <span>ì¸í”„ë¼</span>
          </div>
        </div>
      </nav>

      <!-- Content Area -->
      <main class="content">
        <!-- Tab 1: ì‹¤ì‹œê°„ ë¡œê¹… -->
        <div id="tab-logging" class="tab-content active">
          <div class="section-title">ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê¹…</div>

          <div class="btn-group">
            <button class="filter-btn active" data-filter-type="level" data-filter-value="ALL" onclick="setLogFilter('level', 'ALL', this)">ì „ì²´</button>
            <button class="filter-btn" data-filter-type="level" data-filter-value="INFO" onclick="setLogFilter('level', 'INFO', this)">INFO</button>
            <button class="filter-btn" data-filter-type="level" data-filter-value="WARN" onclick="setLogFilter('level', 'WARN', this)">WARN</button>
            <button class="filter-btn" data-filter-type="level" data-filter-value="ERROR" onclick="setLogFilter('level', 'ERROR', this)">ERROR</button>
          </div>

          <div class="btn-group">
            <button class="filter-btn active" data-filter-type="category" data-filter-value="ALL" onclick="setLogFilter('category', 'ALL', this)">ì „ì²´</button>
            <button class="filter-btn" data-filter-type="category" data-filter-value="MANAGER" onclick="setLogFilter('category', 'MANAGER', this)">MANAGER</button>
            <button class="filter-btn" data-filter-type="category" data-filter-value="BOT" onclick="setLogFilter('category', 'BOT', this)">BOT</button>
            <button class="filter-btn" data-filter-type="category" data-filter-value="DEVICE" onclick="setLogFilter('category', 'DEVICE', this)">DEVICE</button>
            <button class="filter-btn" data-filter-type="category" data-filter-value="WATCH" onclick="setLogFilter('category', 'WATCH', this)">WATCH</button>
            <button class="filter-btn" data-filter-type="category" data-filter-value="SYSTEM" onclick="setLogFilter('category', 'SYSTEM', this)">SYSTEM</button>
          </div>

          <div class="log-container" id="logContainer">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“‹</div>
              <div class="empty-state-text">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
          </div>
        </div>

        <!-- Tab 2: íˆíŠ¸ë§µ -->
        <div id="tab-heatmap" class="tab-content">
          <div class="section-title">ğŸ“Š íˆíŠ¸ë§µ</div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">ì—°ê²°ëœ ê¸°ê¸°</div>
              <div class="stat-value success" id="heatmap-connected">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ì‹œì²­ì¤‘ ê¸°ê¸°</div>
              <div class="stat-value warning" id="heatmap-watching">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ì¢…ë£Œëœ ê¸°ê¸°</div>
              <div class="stat-value" id="heatmap-ended">0</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">ê¸°ê¸° í™œë™ í˜„í™©</div>
            </div>
            <div class="card-content" id="heatmapData">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“Š</div>
                <div class="empty-state-text">íˆíŠ¸ë§µ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab 3: ê¸°ê¸°ê´€ë¦¬ -->
        <div id="tab-devices" class="tab-content">
          <div class="section-title">ğŸ“± ê¸°ê¸°ê´€ë¦¬</div>

          <div class="card">
            <table class="table" id="deviceTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>ì´ë¦„</th>
                  <th>ì‹œë¦¬ì–¼</th>
                  <th>ìƒíƒœ</th>
                  <th>ë°°í„°ë¦¬</th>
                  <th>ë…¸ë“œ</th>
                  <th>ë§ˆì§€ë§‰ í™•ì¸</th>
                  <th>ë™ì‘</th>
                </tr>
              </thead>
              <tbody id="deviceTableBody">
                <tr>
                  <td colspan="8">
                    <div class="empty-state">
                      <div class="empty-state-icon">ğŸ“±</div>
                      <div class="empty-state-text">ì—°ê²°ëœ ê¸°ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                      <div class="empty-state-subtext">ADBë¡œ ê¸°ê¸°ë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tab 4: í´ë¼ì´ì–¸íŠ¸ -->
        <div id="tab-clients" class="tab-content">
          <div class="section-title">ğŸ¤– í´ë¼ì´ì–¸íŠ¸</div>

          <div class="section-subtitle">Manager ìƒíƒœ</div>
          <div class="card">
            <div class="card-content" id="managerStatus">
              <div>ìƒíƒœ: <span id="managerConnected">ì—°ê²° ëŠê¹€</span></div>
              <div>ë…¸ë“œ ID: <span id="managerNodeId">-</span></div>
              <div>ê°€ë™ì‹œê°„: <span id="managerUptime">-</span></div>
            </div>
          </div>

          <div class="section-subtitle">Bot Fleet</div>
          <div class="card">
            <table class="table" id="botFleetTable">
              <thead>
                <tr>
                  <th>Key</th>
                  <th>ì´ë¦„</th>
                  <th>ì¹´í…Œê³ ë¦¬</th>
                  <th>ìƒíƒœ</th>
                  <th>ë§ˆì§€ë§‰ í™œë™</th>
                </tr>
              </thead>
              <tbody id="botFleetBody">
                <tr>
                  <td colspan="5">
                    <div class="empty-state">
                      <div class="empty-state-icon">ğŸ¤–</div>
                      <div class="empty-state-text">Bot ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="section-subtitle">Bot Pipeline</div>
          <div class="pipeline-stepper">
            <div class="pipeline-step">
              <div class="pipeline-step-icon">ğŸ“‹</div>
              <div class="pipeline-step-label">ìº í˜ì¸</div>
            </div>
            <div class="pipeline-arrow">â†’</div>
            <div class="pipeline-step">
              <div class="pipeline-step-icon">ğŸ”</div>
              <div class="pipeline-step-label">í‚¤ì›Œë“œ</div>
            </div>
            <div class="pipeline-arrow">â†’</div>
            <div class="pipeline-step active">
              <div class="pipeline-step-icon">ğŸ”</div>
              <div class="pipeline-step-label">ê²€ìƒ‰</div>
            </div>
            <div class="pipeline-arrow">â†’</div>
            <div class="pipeline-step">
              <div class="pipeline-step-icon">âš™ï¸</div>
              <div class="pipeline-step-label">ì¤€ë¹„</div>
            </div>
            <div class="pipeline-arrow">â†’</div>
            <div class="pipeline-step">
              <div class="pipeline-step-icon">ğŸ‘€</div>
              <div class="pipeline-step-label">ì‹œì²­</div>
            </div>
            <div class="pipeline-arrow">â†’</div>
            <div class="pipeline-step">
              <div class="pipeline-step-icon">âœ¨</div>
              <div class="pipeline-step-label">ì•¡ì…˜</div>
            </div>
            <div class="pipeline-arrow">â†’</div>
            <div class="pipeline-step">
              <div class="pipeline-step-icon">âœ…</div>
              <div class="pipeline-step-label">ì¢…ë£Œ</div>
            </div>
          </div>

          <div class="section-subtitle">ğŸ¤– ë´‡ ì¹´íƒˆë¡œê·¸</div>
          <div class="bot-catalog-grid" id="botCatalog">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ¤–</div>
              <div class="empty-state-text">ë´‡ ì¹´íƒˆë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
          </div>
        </div>

        <!-- Tab 5: ì¸í”„ë¼ -->
        <div id="tab-infra" class="tab-content">
          <div class="section-title">ğŸ”§ ì¸í”„ë¼</div>

          <div style="margin-bottom: 16px;">
            <button class="btn btn-primary" id="runInfraCheck" onclick="runInfraCheck()">ì ê²€ ì‹¤í–‰</button>
          </div>

          <div class="health-grid" id="healthGrid">
            <div class="health-card">
              <div class="health-card-header">
                <div class="health-card-title">ADB</div>
                <div class="health-status missing">í™•ì¸ì¤‘</div>
              </div>
              <div class="health-card-body">
                <div>ë§ˆì§€ë§‰ ì ê²€: -</div>
                <div>ë²„ì „: -</div>
              </div>
            </div>

            <div class="health-card">
              <div class="health-card-header">
                <div class="health-card-title">UIAutomator2</div>
                <div class="health-status missing">í™•ì¸ì¤‘</div>
              </div>
              <div class="health-card-body">
                <div>ë§ˆì§€ë§‰ ì ê²€: -</div>
                <div>ë²„ì „: -</div>
              </div>
            </div>

            <div class="health-card">
              <div class="health-card-header">
                <div class="health-card-title">Appium</div>
                <div class="health-status missing">í™•ì¸ì¤‘</div>
              </div>
              <div class="health-card-body">
                <div>ë§ˆì§€ë§‰ ì ê²€: -</div>
                <div>ë²„ì „: -</div>
              </div>
            </div>

            <div class="health-card">
              <div class="health-card-header">
                <div class="health-card-title">scrcpy</div>
                <div class="health-status missing">í™•ì¸ì¤‘</div>
              </div>
              <div class="health-card-body">
                <div>ë§ˆì§€ë§‰ ì ê²€: -</div>
                <div>ë²„ì „: -</div>
              </div>
            </div>

            <div class="health-card">
              <div class="health-card-header">
                <div class="health-card-title">Backend</div>
                <div class="health-status missing">í™•ì¸ì¤‘</div>
              </div>
              <div class="health-card-body">
                <div>ë§ˆì§€ë§‰ ì ê²€: -</div>
                <div>ìƒíƒœ: -</div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Device Detail Panel Overlay -->
    <div class="device-panel-overlay" id="devicePanelOverlay" onclick="closeDevicePanel()"></div>

    <!-- Device Detail Panel -->
    <div class="device-panel" id="devicePanel">
      <div class="device-panel-header">
        <div>
          <div class="device-panel-title" id="panelDeviceName">-</div>
          <div class="device-panel-serial" id="panelDeviceSerial">-</div>
        </div>
        <button class="device-panel-close" onclick="closeDevicePanel()">&times;</button>
      </div>
      <div class="device-panel-body">
        <div class="device-info-grid">
          <div class="device-info-card">
            <div class="device-info-label">ìƒíƒœ</div>
            <div class="device-info-value" id="panelDeviceStatus">-</div>
          </div>
          <div class="device-info-card">
            <div class="device-info-label">ë°°í„°ë¦¬</div>
            <div class="device-info-value" id="panelDeviceBattery">-</div>
          </div>
          <div class="device-info-card">
            <div class="device-info-label">ëª¨ë¸</div>
            <div class="device-info-value" id="panelDeviceModel">-</div>
          </div>
          <div class="device-info-card">
            <div class="device-info-label">ë§ˆì§€ë§‰ í™•ì¸</div>
            <div class="device-info-value" id="panelDeviceLastSeen">-</div>
          </div>
        </div>

        <div class="section-subtitle" style="margin-top: 0;">í™”ë©´ ì œì–´</div>
        <button class="btn-scrcpy" id="panelScrcpyBtn" onclick="toggleScrcpy()">
          <span id="panelScrcpyIcon">ğŸ“º</span>
          <span id="panelScrcpyText">í™”ë©´ ë³´ê¸° / ì œì–´</span>
        </button>

        <div class="section-subtitle">ë””ë°”ì´ìŠ¤ ëª…ë ¹</div>
        <div class="device-action-grid">
          <button class="btn btn-secondary" onclick="panelDeviceAction('wake')">í™”ë©´ ì¼œê¸°</button>
          <button class="btn btn-secondary" onclick="panelDeviceAction('sleep')">í™”ë©´ ë„ê¸°</button>
          <button class="btn btn-secondary" onclick="panelDeviceAction('reconnect')">ì¬ì—°ê²°</button>
          <button class="btn btn-secondary" onclick="panelDeviceAction('reboot')">ì¬ë¶€íŒ…</button>
        </div>

        <div class="section-subtitle">APK ì„¤ì¹˜</div>
        <div class="apk-section">
          <div class="apk-list" id="panelApkList">
            <div class="apk-empty">APK ëª©ë¡ ë¡œë”© ì¤‘...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <span>DoAi.Me v1.2.3</span>
      <span id="lastUpdate">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
    </footer>
  </div>

  <script>
  (function() {
    'use strict';
    // ============================================
    // State
    // ============================================
    const state = {
      nodeId: 'NODE-1',
      serverConnected: false,
      currentTab: 'logging',
      devices: [],
      logs: [],
      maxLogs: 500,
      filters: {
        level: 'ALL',
        category: 'ALL'
      },
      heatmapData: null,
      botRegistry: [],
      infraHealth: null,
      managerStatus: null,
      botFleetStatus: [],
      scrcpyActive: {},
      selectedDeviceSerial: null
    };

    // ============================================
    // API (from preload.js)
    // ============================================
    const api = window.api || {
      getConfig: () => Promise.resolve({ nodeId: 'DEV-NODE' }),
      getNodeStatus: () => Promise.resolve({ serverConnected: false, workerServerRunning: false, deviceCount: 0 }),
      getDevices: () => Promise.resolve([]),
      getLogs: () => Promise.resolve([]),
      onDeviceUpdate: () => {},
      onLogEntry: () => {},
      onServerStatus: () => {},
      getBotRegistry: () => Promise.resolve([]),
      getHeatmapData: () => Promise.resolve(null),
      getInfraHealth: () => Promise.resolve(null),
      getManagerStatus: () => Promise.resolve(null),
      getBotFleetStatus: () => Promise.resolve([]),
      runInfraCheck: () => Promise.resolve(null),
      startScrcpy: () => Promise.resolve({ success: false }),
      stopScrcpy: () => Promise.resolve({ success: false }),
      isScrcpyActive: () => Promise.resolve(false),
      getBundledApks: () => Promise.resolve([]),
      installApk: () => Promise.resolve({ success: false, message: 'Not available' })
    };

    // ============================================
    // Tab Navigation
    // ============================================
    function switchTab(tabName) {
      state.currentTab = tabName;

      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tabName);
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
      });

      // Load tab data
      loadTabData(tabName);
    }

    // ============================================
    // Tab Data Loading
    // ============================================
    async function loadTabData(tabName) {
      try {
        switch (tabName) {
          case 'logging':
            renderLogs();
            break;
          case 'heatmap':
            await loadHeatmapData();
            break;
          case 'devices':
            renderDeviceTable();
            break;
          case 'clients':
            await loadClientData();
            break;
          case 'infra':
            await loadInfraHealth();
            break;
        }
      } catch (err) {
        console.error(`Failed to load ${tabName} data:`, err);
      }
    }

    // ============================================
    // Logging Tab
    // ============================================
    function addLog(log) {
      state.logs.unshift({
        timestamp: log.timestamp || Date.now(),
        level: log.level || 'INFO',
        category: log.category || 'SYSTEM',
        message: log.message || ''
      });

      if (state.logs.length > state.maxLogs) {
        state.logs = state.logs.slice(0, state.maxLogs);
      }

      if (state.currentTab === 'logging') {
        renderLogs();
      }
    }

    function setLogFilter(filterType, filterValue, btnElement) {
      state.filters[filterType] = filterValue;

      // Update button states
      document.querySelectorAll(`[data-filter-type="${filterType}"]`).forEach(btn => {
        btn.classList.remove('active');
      });
      btnElement.classList.add('active');

      renderLogs();
    }

    function renderLogs() {
      const filteredLogs = state.logs.filter(log => {
        const levelMatch = state.filters.level === 'ALL' || log.level === state.filters.level;
        const categoryMatch = state.filters.category === 'ALL' || log.category === state.filters.category;
        return levelMatch && categoryMatch;
      });

      const container = document.getElementById('logContainer');

      if (filteredLogs.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <div class="empty-state-text">í•„í„°ì™€ ì¼ì¹˜í•˜ëŠ” ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredLogs.map(log => `
        <div class="log-entry">
          <span class="log-time">${formatTime(log.timestamp)}</span>
          <span class="log-level-badge ${log.level}">${log.level}</span>
          <span class="log-category">${log.category}</span>
          <span class="log-message">${escapeHtml(log.message)}</span>
        </div>
      `).join('');

      // Auto-scroll to top (most recent)
      container.scrollTop = 0;
    }

    // ============================================
    // Heatmap Tab
    // ============================================
    async function loadHeatmapData() {
      try {
        if (api.getHeatmapData) {
          state.heatmapData = await api.getHeatmapData();
        }
        renderHeatmap();
      } catch (err) {
        console.error('Failed to load heatmap data:', err);
        renderHeatmap();
      }
    }

    function renderHeatmap() {
      if (!state.heatmapData) {
        // Show placeholder data from devices
        const connected = state.devices.filter(d => d.status === 'online' || d.status === 'idle').length;
        const watching = state.devices.filter(d => d.status === 'busy' || d.status === 'running').length;
        const ended = state.devices.filter(d => d.status === 'offline').length;

        document.getElementById('heatmap-connected').textContent = connected;
        document.getElementById('heatmap-watching').textContent = watching;
        document.getElementById('heatmap-ended').textContent = ended;

        document.getElementById('heatmapData').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <div class="empty-state-text">íˆíŠ¸ë§µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div class="empty-state-subtext">ê¸°ê¸°ê°€ ì—°ê²°ë˜ë©´ í™œë™ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
          </div>
        `;
        return;
      }

      // Render actual heatmap data
      document.getElementById('heatmap-connected').textContent = state.heatmapData.connected || 0;
      document.getElementById('heatmap-watching').textContent = state.heatmapData.watching || 0;
      document.getElementById('heatmap-ended').textContent = state.heatmapData.ended || 0;

      document.getElementById('heatmapData').innerHTML = '<pre style="font-size: 11px; line-height: 1.5;">' +
        JSON.stringify(state.heatmapData, null, 2) + '</pre>';
    }

    // ============================================
    // Devices Tab
    // ============================================
    function renderDeviceTable() {
      const tbody = document.getElementById('deviceTableBody');

      if (state.devices.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“±</div>
                <div class="empty-state-text">ì—°ê²°ëœ ê¸°ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="empty-state-subtext">ADBë¡œ ê¸°ê¸°ë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = state.devices.map((device, index) => {
        const statusClass = {
          online: 'online',
          idle: 'online',
          busy: 'busy',
          running: 'busy',
          error: 'error',
          offline: 'offline'
        }[device.status] || 'offline';

        const statusText = {
          online: 'ONLINE',
          idle: 'ONLINE',
          busy: 'BUSY',
          running: 'BUSY',
          error: 'ERROR',
          offline: 'OFFLINE'
        }[device.status] || 'OFFLINE';

        const serial = device.serial || device.id;
        const isScrcpy = state.scrcpyActive[serial];

        return `
          <tr class="clickable ${isScrcpy ? 'scrcpy-active' : ''}" onclick="openDevicePanel('${escapeAttr(serial)}')">
            <td>${index + 1}</td>
            <td>${escapeHtml(device.name || device.id)}</td>
            <td style="font-family: monospace; font-size: 11px;">${escapeHtml(serial)}</td>
            <td><span class="badge ${statusClass}"><span class="badge-dot"></span>${statusText}</span></td>
            <td>ğŸ”‹ ${device.battery || 0}%</td>
            <td>${escapeHtml(state.nodeId)}</td>
            <td>${formatTime(device.lastSeen || Date.now())}</td>
            <td>
              ${isScrcpy ? '<span class="scrcpy-indicator">ğŸ“º ë³´ê¸°ì¤‘</span>' : ''}
              <button class="btn btn-secondary" onclick="event.stopPropagation(); refreshDevice('${escapeAttr(device.id)}')">ìƒˆë¡œê³ ì¹¨</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function refreshDevice(deviceId) {
      addLog({ level: 'INFO', category: 'DEVICE', message: `ê¸°ê¸° ìƒˆë¡œê³ ì¹¨: ${deviceId}` });
    }

    // ============================================
    // Device Detail Panel
    // ============================================

    function openDevicePanel(serial) {
      state.selectedDeviceSerial = serial;
      const device = state.devices.find(d => (d.serial || d.id) === serial);

      if (!device) return;

      // íŒ¨ë„ ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('panelDeviceName').textContent = device.name || device.model || serial;
      document.getElementById('panelDeviceSerial').textContent = serial;

      const statusEl = document.getElementById('panelDeviceStatus');
      statusEl.textContent = (device.status || 'offline').toUpperCase();
      statusEl.style.color =
        (device.status === 'online' || device.status === 'idle') ? 'var(--success)' :
        (device.status === 'busy' || device.status === 'running') ? 'var(--warning)' :
        device.status === 'error' ? 'var(--error)' : 'var(--text-secondary)';

      document.getElementById('panelDeviceBattery').textContent = (device.battery || 0) + '%';
      document.getElementById('panelDeviceModel').textContent = device.model || 'Unknown';
      document.getElementById('panelDeviceLastSeen').textContent = formatTime(device.lastActivity || device.lastSeen || Date.now());

      updateScrcpyButton();
      loadBundledApks();

      // íŒ¨ë„ ì—´ê¸°
      document.getElementById('devicePanel').classList.add('open');
      document.getElementById('devicePanelOverlay').classList.add('open');
    }

    function closeDevicePanel() {
      document.getElementById('devicePanel').classList.remove('open');
      document.getElementById('devicePanelOverlay').classList.remove('open');
      state.selectedDeviceSerial = null;
    }

    function updateScrcpyButton() {
      const btn = document.getElementById('panelScrcpyBtn');
      const icon = document.getElementById('panelScrcpyIcon');
      const text = document.getElementById('panelScrcpyText');
      const isActive = state.scrcpyActive[state.selectedDeviceSerial];

      if (isActive) {
        btn.classList.add('active');
        icon.textContent = 'ğŸŸ¢';
        text.textContent = 'í™”ë©´ ë³´ê¸° ì¤‘ (í´ë¦­í•˜ì—¬ ì¤‘ì§€)';
      } else {
        btn.classList.remove('active');
        icon.textContent = 'ğŸ“º';
        text.textContent = 'í™”ë©´ ë³´ê¸° / ì œì–´';
      }
    }

    async function toggleScrcpy() {
      if (!state.selectedDeviceSerial) return;

      const btn = document.getElementById('panelScrcpyBtn');
      btn.disabled = true;

      try {
        if (state.scrcpyActive[state.selectedDeviceSerial]) {
          await api.stopScrcpy(state.selectedDeviceSerial);
          state.scrcpyActive[state.selectedDeviceSerial] = false;
          addLog({ level: 'INFO', category: 'DEVICE', message: 'scrcpy ì¢…ë£Œ: ' + state.selectedDeviceSerial });
        } else {
          await api.startScrcpy(state.selectedDeviceSerial);
          state.scrcpyActive[state.selectedDeviceSerial] = true;
          addLog({ level: 'INFO', category: 'DEVICE', message: 'scrcpy ì‹œì‘: ' + state.selectedDeviceSerial });
        }
      } catch (err) {
        addLog({ level: 'ERROR', category: 'DEVICE', message: 'scrcpy ì˜¤ë¥˜: ' + err.message });
      } finally {
        btn.disabled = false;
        updateScrcpyButton();
        if (state.currentTab === 'devices') {
          renderDeviceTable();
        }
      }
    }

    async function panelDeviceAction(action) {
      if (!state.selectedDeviceSerial) return;

      try {
        const result = await api.executeDeviceAction(state.selectedDeviceSerial, action);
        addLog({
          level: result.success ? 'INFO' : 'ERROR',
          category: 'DEVICE',
          message: action + ': ' + result.message
        });

        // ë””ë°”ì´ìŠ¤ ìƒì„¸ ì •ë³´ ê°±ì‹ 
        if (api.getDeviceDetail) {
          const detail = await api.getDeviceDetail(state.selectedDeviceSerial);
          if (detail) {
            document.getElementById('panelDeviceStatus').textContent = (detail.state || 'offline').toUpperCase();
            document.getElementById('panelDeviceBattery').textContent = (detail.battery || 0) + '%';
          }
        }
      } catch (err) {
        addLog({ level: 'ERROR', category: 'DEVICE', message: 'ëª…ë ¹ ì‹¤íŒ¨ (' + action + '): ' + err.message });
      }
    }

    // ============================================
    // APK Install Functions
    // ============================================
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function getApkIcon(name) {
      const lower = name.toLowerCase();
      if (lower.includes('youtube')) return 'â–¶';
      if (lower.includes('appium') || lower.includes('settings')) return 'âš™';
      return 'ğŸ“¦';
    }

    async function loadBundledApks() {
      const container = document.getElementById('panelApkList');
      if (!container) return;

      try {
        const apks = await api.getBundledApks();

        if (!apks || apks.length === 0) {
          container.innerHTML = '<div class="apk-empty">ë²ˆë“¤ëœ APKê°€ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }

        container.innerHTML = apks.map(apk => `
          <div class="apk-card" data-apk="${apk.fileName}">
            <div class="apk-icon">${getApkIcon(apk.name)}</div>
            <div class="apk-info">
              <div class="apk-name">${apk.name}</div>
              <div class="apk-size">${formatFileSize(apk.size)}</div>
            </div>
            <button class="btn-apk-install" onclick="installApk('${apk.fileName}', this)">ì„¤ì¹˜</button>
          </div>
        `).join('');
      } catch (err) {
        container.innerHTML = '<div class="apk-empty">APK ëª©ë¡ ë¡œë”© ì‹¤íŒ¨</div>';
        console.error('loadBundledApks error:', err);
      }
    }

    async function installApk(fileName, btnElement) {
      if (!state.selectedDeviceSerial || !btnElement) return;

      btnElement.disabled = true;
      btnElement.textContent = 'ì„¤ì¹˜ ì¤‘...';

      try {
        const result = await api.installApk(state.selectedDeviceSerial, fileName);

        if (result.success) {
          btnElement.textContent = 'ì™„ë£Œ';
          btnElement.classList.add('success');
          addLog({ level: 'INFO', category: 'DEVICE', message: 'APK ì„¤ì¹˜ ì™„ë£Œ: ' + fileName });
        } else {
          btnElement.textContent = 'ì‹¤íŒ¨';
          btnElement.classList.add('error');
          addLog({ level: 'ERROR', category: 'DEVICE', message: 'APK ì„¤ì¹˜ ì‹¤íŒ¨: ' + (result.message || fileName) });
        }

        // 3ì´ˆ í›„ ë²„íŠ¼ ë³µì›
        setTimeout(() => {
          btnElement.textContent = 'ì„¤ì¹˜';
          btnElement.classList.remove('success', 'error');
          btnElement.disabled = false;
        }, 3000);
      } catch (err) {
        btnElement.textContent = 'ì˜¤ë¥˜';
        btnElement.classList.add('error');
        btnElement.disabled = false;
        addLog({ level: 'ERROR', category: 'DEVICE', message: 'APK ì„¤ì¹˜ ì˜¤ë¥˜: ' + err.message });

        setTimeout(() => {
          btnElement.textContent = 'ì„¤ì¹˜';
          btnElement.classList.remove('error');
        }, 3000);
      }
    }

    // ============================================
    // Clients Tab
    // ============================================
    async function loadClientData() {
      try {
        if (api.getManagerStatus) {
          state.managerStatus = await api.getManagerStatus();
        }
        if (api.getBotFleetStatus) {
          state.botFleetStatus = await api.getBotFleetStatus();
        }
        if (api.getBotRegistry) {
          state.botRegistry = await api.getBotRegistry();
        }
        renderClientData();
      } catch (err) {
        console.error('Failed to load client data:', err);
        renderClientData();
      }
    }

    function renderClientData() {
      // Manager Status
      if (state.managerStatus) {
        document.getElementById('managerConnected').textContent = state.managerStatus.connected ? 'ì—°ê²°ë¨' : 'ì—°ê²° ëŠê¹€';
        document.getElementById('managerConnected').style.color = state.managerStatus.connected ? 'var(--success)' : 'var(--error)';
        document.getElementById('managerNodeId').textContent = state.managerStatus.nodeId || '-';
        document.getElementById('managerUptime').textContent = state.managerStatus.uptime || '-';
      } else {
        document.getElementById('managerConnected').textContent = 'ì—°ê²° ëŠê¹€';
        document.getElementById('managerConnected').style.color = 'var(--error)';
        document.getElementById('managerNodeId').textContent = '-';
        document.getElementById('managerUptime').textContent = '-';
      }

      // Bot Fleet
      const botFleetBody = document.getElementById('botFleetBody');
      if (state.botFleetStatus.length === 0) {
        botFleetBody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ¤–</div>
                <div class="empty-state-text">ì‹¤í–‰ ì¤‘ì¸ Botì´ ì—†ìŠµë‹ˆë‹¤</div>
              </div>
            </td>
          </tr>
        `;
      } else {
        botFleetBody.innerHTML = state.botFleetStatus.map(bot => `
          <tr>
            <td>${escapeHtml(bot.key)}</td>
            <td>${escapeHtml(bot.nameKo || bot.name)}</td>
            <td>${escapeHtml(bot.category || '-')}</td>
            <td><span class="badge ${bot.status}">${bot.status}</span></td>
            <td>${formatTime(bot.lastActivity || Date.now())}</td>
          </tr>
        `).join('');
      }

      // Bot Catalog
      const botCatalog = document.getElementById('botCatalog');
      if (state.botRegistry.length === 0) {
        botCatalog.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¤–</div>
            <div class="empty-state-text">ë´‡ ì¹´íƒˆë¡œê·¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>
          </div>
        `;
      } else {
        botCatalog.innerHTML = state.botRegistry.map(bot => `
          <div class="bot-card">
            <div class="bot-card-header">
              <div class="bot-icon">ğŸ¤–</div>
              <div class="bot-info">
                <div class="bot-name">${escapeHtml(bot.nameKo || bot.name)}</div>
                <div class="bot-category">${escapeHtml(bot.category || 'General')}</div>
              </div>
            </div>
            <div class="bot-description">${escapeHtml(bot.description || 'ì„¤ëª… ì—†ìŒ')}</div>
            <div class="bot-capabilities">
              ${(bot.capabilities || []).map(cap => `<span class="bot-tag">${escapeHtml(cap)}</span>`).join('')}
            </div>
          </div>
        `).join('');
      }
    }

    // ============================================
    // Infra Tab
    // ============================================
    async function loadInfraHealth() {
      try {
        if (api.getInfraHealth) {
          state.infraHealth = await api.getInfraHealth();
        }
        renderInfraHealth();
      } catch (err) {
        console.error('Failed to load infra health:', err);
        renderInfraHealth();
      }
    }

    function renderInfraHealth() {
      if (!state.infraHealth) {
        // Keep default placeholders
        return;
      }

      const services = ['adb', 'uiautomator2', 'appium', 'scrcpy', 'backend'];
      const healthGrid = document.getElementById('healthGrid');

      healthGrid.innerHTML = services.map(service => {
        const health = state.infraHealth[service] || {};
        const statusClass = health.status === 'ok' ? 'ok' : health.status === 'error' ? 'error' : 'missing';
        const statusText = health.status === 'ok' ? 'ì •ìƒ' : health.status === 'error' ? 'ì˜¤ë¥˜' : 'ë¯¸ì„¤ì¹˜';

        return `
          <div class="health-card">
            <div class="health-card-header">
              <div class="health-card-title">${service === 'uiautomator2' ? 'UIAutomator2' : service.toUpperCase()}</div>
              <div class="health-status ${statusClass}">${statusText}</div>
            </div>
            <div class="health-card-body">
              <div>ë§ˆì§€ë§‰ ì ê²€: ${health.lastCheck ? formatTime(health.lastCheck) : '-'}</div>
              <div>ë²„ì „: ${health.version || '-'}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function runInfraCheck() {
      try {
        if (api.runInfraCheck) {
          addLog({ level: 'INFO', category: 'SYSTEM', message: 'ì¸í”„ë¼ ì ê²€ ì‹œì‘...' });
          state.infraHealth = await api.runInfraCheck();
          renderInfraHealth();
          addLog({ level: 'INFO', category: 'SYSTEM', message: 'ì¸í”„ë¼ ì ê²€ ì™„ë£Œ' });
        }
      } catch (err) {
        addLog({ level: 'ERROR', category: 'SYSTEM', message: `ì¸í”„ë¼ ì ê²€ ì‹¤íŒ¨: ${err.message}` });
      }
    }

    // ============================================
    // Server Status
    // ============================================
    function updateServerStatus(connected, message) {
      state.serverConnected = connected;

      const statusEl = document.getElementById('serverStatus');
      statusEl.className = 'status-badge ' +
        (connected ? 'connected' : message === 'ì—°ê²° ì¤‘...' ? 'connecting' : 'disconnected');
      document.getElementById('serverStatusText').textContent = message || (connected ? 'ì—°ê²°ë¨' : 'ì—°ê²° ëŠê¹€');

      const dot = statusEl.querySelector('.status-dot');
      dot.className = 'status-dot' + (message === 'ì—°ê²° ì¤‘...' ? ' pulse' : '');

      // ë°°ë„ˆë„ ê°±ì‹ 
      updateNodeStatusBanner();
    }

    // ============================================
    // Node Status Banner (v1.2.0)
    // ============================================
    async function updateNodeStatusBanner() {
      try {
        if (!api.getNodeStatus) return;
        const ns = await api.getNodeStatus();
        document.getElementById('nsBannerServer').className =
          'ns-dot ' + (ns.serverConnected ? 'ok' : 'off');
        document.getElementById('nsBannerWorker').className =
          'ns-dot ' + (ns.workerServerRunning ? 'ok' : 'off');
        document.getElementById('nsBannerDevices').textContent =
          `ê¸°ê¸° ${ns.deviceCount}ëŒ€`;
      } catch (err) {
        console.error('Failed to update node status banner:', err);
      }
    }

    // ============================================
    // Utility Functions
    // ============================================
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('ko-KR', { hour12: false });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    function escapeAttr(text) {
      return String(text).replace(/'/g, "\\'");
    }

    function updateLastUpdate() {
      document.getElementById('lastUpdate').textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${formatTime(Date.now())}`;
    }

    // ============================================
    // Initialize
    // ============================================
    async function init() {
      try {
        // Get config
        const config = await api.getConfig();
        state.nodeId = config.nodeId || 'NODE-1';
        document.getElementById('nodeId').textContent = state.nodeId;

        // Node status banner (v1.2.0)
        updateNodeStatusBanner();

        // Register event listeners
        if (api.onServerStatus) {
          api.onServerStatus((event, { connected, message }) => {
            updateServerStatus(connected, message);
          });
        }

        // ì´ˆê¸° ì„œë²„ ìƒíƒœ ì¡°íšŒ (ì´ë²¤íŠ¸ ë†“ì¹¨ ë°©ì§€)
        if (api.getServerStatus) {
          const status = await api.getServerStatus();
          updateServerStatus(status.connected, status.message);
        }

        if (api.onDeviceUpdate) {
          api.onDeviceUpdate((event, devices) => {
            state.devices = devices;
            if (state.currentTab === 'devices') {
              renderDeviceTable();
            }
            if (state.currentTab === 'heatmap') {
              renderHeatmap();
            }
            updateNodeStatusBanner();
            updateLastUpdate();
          });
        }

        if (api.onLogEntry) {
          api.onLogEntry((event, log) => {
            addLog(log);
          });
        }

        // Load initial data
        const devices = await api.getDevices();
        state.devices = devices || [];

        const logs = await api.getLogs();
        state.logs = logs || [];

        // Load current tab data
        await loadTabData(state.currentTab);

        // Startup log
        addLog({
          timestamp: Date.now(),
          level: 'INFO',
          category: 'SYSTEM',
          message: 'Desktop Agent UI v1.2.0 ì´ˆê¸°í™” ì™„ë£Œ'
        });

        updateLastUpdate();

      } catch (err) {
        console.error('Init error:', err);
        addLog({
          timestamp: Date.now(),
          level: 'ERROR',
          category: 'SYSTEM',
          message: `ì´ˆê¸°í™” ì˜¤ë¥˜: ${err.message}`
        });
      }
    }

    // Expose functions used by inline onclick handlers
    window.switchTab = switchTab;
    window.setLogFilter = setLogFilter;
    window.runInfraCheck = runInfraCheck;
    window.closeDevicePanel = closeDevicePanel;
    window.toggleScrcpy = toggleScrcpy;
    window.panelDeviceAction = panelDeviceAction;
    window.openDevicePanel = openDevicePanel;
    window.refreshDevice = refreshDevice;
    window.installApk = installApk;

    // ìƒˆë¡œê³ ì¹¨ (ì„œë²„ ì¬ì—°ê²°)
    function handleRefresh() {
      addLog({ level: 'INFO', category: 'SYSTEM', message: 'ì„œë²„ ì¬ì—°ê²° ì‹œë„...' });
      updateServerStatus(false, 'ì—°ê²° ì¤‘...');
      api.reconnectServer();
    }

    // ì¬ì‹œì‘ (ì•± ì „ì²´ ì¬ì‹œì‘)
    function handleRestart() {
      if (confirm('ì•±ì„ ì¬ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        addLog({ level: 'INFO', category: 'SYSTEM', message: 'ì•± ì¬ì‹œì‘ ì¤‘...' });
        api.restartApp();
      }
    }

    window.handleRefresh = handleRefresh;
    window.handleRestart = handleRestart;

    // Start
    init();
  })();
  </script>
</body>
</html>
