# ===========================================
# DoAi.Me CI/CD Pipeline
# Automated deployment to Vultr VPS
# ===========================================

name: Deploy to Production

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'apps/dashboard/**'
      - 'packages/**'
      - 'infra/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy target (all/backend/frontend)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend

env:
  DEPLOY_PATH: /opt/doai-me
  DOCKER_COMPOSE_FILE: infra/docker/docker-compose.yml

# Concurrency: Í∞ôÏùÄ Î∏åÎûúÏπòÏóêÏÑú ÎèôÏãúÏóê ÌïòÎÇòÏùò Î∞∞Ìè¨Îßå Ïã§Ìñâ
concurrency:
  group: deploy-production-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # 1. Test & Lint
  # ===========================================
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present
        continue-on-error: true

      - name: Type check
        run: npm run typecheck --if-present
        continue-on-error: true

  # ===========================================
  # 2. Build Docker Images
  # Note: ÌòÑÏû¨ Ïù¥ÎØ∏ÏßÄÎ•º Î†àÏßÄÏä§Ìä∏Î¶¨Ïóê pushÌïòÏßÄ ÏïäÍ≥†
  # VPSÏóêÏÑú docker compose build --no-cacheÎ°ú ÏßÅÏ†ë ÎπåÎìúÌïòÎØÄÎ°ú
  # Ïù¥ jobÏùÄ ÎπåÎìú Í≤ÄÏ¶ùÏö©ÏúºÎ°úÎßå ÏÇ¨Ïö©Îê©ÎãàÎã§.
  # Ï∂îÌõÑ Î†àÏßÄÏä§Ìä∏Î¶¨ pushÍ∞Ä ÌïÑÏöîÌïòÎ©¥ docker/login-actionÍ≥º
  # docker pushÎ•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.
  # ===========================================
  build:
    name: Build Docker Images (Validation)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend Image (validation only)
        run: |
          docker build -t doai-backend:${{ github.sha }} ./apps/backend
          echo "Backend image built successfully (not pushed - VPS rebuilds directly)"

      - name: Build Frontend Image (validation only)
        run: |
          docker build -t doai-frontend:${{ github.sha }} ./apps/dashboard
          echo "Frontend image built successfully (not pushed - VPS rebuilds directly)"

  # ===========================================
  # 3. Deploy to VPS
  # ===========================================
  deploy:
    name: Deploy to Vultr VPS
    runs-on: ubuntu-latest
    needs: build
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          HOST: ${{ secrets.VPS_HOST }}
          USER: ${{ secrets.VPS_USERNAME }}
          DEPLOY_TARGET: ${{ github.event.inputs.deploy_target || 'all' }}
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST << 'ENDSSH'
            set -e
            
            echo "============================================="
            echo "üöÄ Starting deployment..."
            echo "============================================="
            
            # ÌîÑÎ°úÏ†ùÌä∏ ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
            cd /opt/doai-me
            
            # ÏµúÏã† ÏΩîÎìú pull
            echo "üì• Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏
            if [ ! -f .env ]; then
              echo "‚ùå .env file not found!"
              exit 1
            fi
            
            # Docker ComposeÎ°ú Ïû¨Î∞∞Ìè¨
            echo "üê≥ Rebuilding and restarting containers..."
            docker compose -f infra/docker/docker-compose.yml down --remove-orphans
            docker compose -f infra/docker/docker-compose.yml build --no-cache
            docker compose -f infra/docker/docker-compose.yml up -d
            
            # Ïò§ÎûòÎêú Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
            echo "üßπ Cleaning up old images..."
            docker image prune -f
            
            # Health check
            echo "üè• Running health checks..."
            sleep 10
            
            # Backend health check
            if curl -sf http://localhost:4000/health > /dev/null; then
              echo "‚úÖ Backend is healthy"
            else
              echo "‚ùå Backend health check failed"
              docker logs doai-backend --tail 50
              exit 1
            fi
            
            # Frontend health check
            if curl -sf http://localhost:3000 > /dev/null; then
              echo "‚úÖ Frontend is healthy"
            else
              echo "‚ùå Frontend health check failed"
              docker logs doai-frontend --tail 50
              exit 1
            fi
            
            echo "============================================="
            echo "‚úÖ Deployment completed!"
            echo "============================================="
          ENDSSH

      - name: Notify on Success
        if: success()
        run: |
          echo "Deployment successful! üéâ"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Deployment failed! ‚ùå"
          echo "Check the logs for details."

  # ===========================================
  # 4. Post-deployment Verification
  # ===========================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for services to stabilize
        run: sleep 30

      - name: Check Production URL
        run: |
          # HTTPS ÌôïÏù∏
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://doai.me || echo "000")
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "‚úÖ Production site is reachable (HTTP $HTTP_STATUS)"
          else
            echo "‚ö†Ô∏è Production site returned HTTP $HTTP_STATUS"
          fi

      - name: Check API Health
        run: |
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://doai.me/api/health || echo "000")
          if [ "$API_STATUS" = "200" ]; then
            echo "‚úÖ API is healthy"
          else
            echo "‚ö†Ô∏è API health check returned HTTP $API_STATUS"
          fi
